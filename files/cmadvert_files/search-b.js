(function($,window){$window=$(window);$.fn.lazyload=function(options){var elements=this;var settings={threshold:0,failure_limit:0,event:"scroll",effect:"show",container:window,data_attribute:"original",skip_invisible:true,appear:null,load:null};function update(){var counter=0;elements.each(function(){var $this=$(this);if(settings.skip_invisible&&!$this.is(":visible")){return;}if($.abovethetop(this,settings)||$.leftofbegin(this,settings)){}else{if(!$.belowthefold(this,settings)&&!$.rightoffold(this,settings)){$this.trigger("appear");}else{if(++counter>settings.failure_limit){return false;}}}});}if(options){if(undefined!==options.failurelimit){options.failure_limit=options.failurelimit;delete options.failurelimit;}if(undefined!==options.effectspeed){options.effect_speed=options.effectspeed;delete options.effectspeed;}$.extend(settings,options);}$container=(settings.container===undefined||settings.container===window)?$window:$(settings.container);if(0===settings.event.indexOf("scroll")){$container.bind(settings.event,function(event){return update();});}this.each(function(){var self=this;var $self=$(self);self.loaded=false;$self.one("appear",function(){if(!this.loaded){if(settings.appear){var elements_left=elements.length;settings.appear.call(self,elements_left,settings);}$("<img />").bind("load",function(){$self.hide().attr("src",$self.data(settings.data_attribute))[settings.effect](settings.effect_speed);self.loaded=true;var temp=$.grep(elements,function(element){return !element.loaded;});elements=$(temp);if(settings.load){var elements_left=elements.length;settings.load.call(self,elements_left,settings);}}).attr("src",$self.data(settings.data_attribute));}});if(0!==settings.event.indexOf("scroll")){$self.bind(settings.event,function(event){if(!self.loaded){$self.trigger("appear");}});}});$window.bind("resize",function(event){update();});update();return this;};$.belowthefold=function(element,settings){var fold;if(settings.container===undefined||settings.container===window){fold=$window.height()+$window.scrollTop();}else{fold=$container.offset().top+$container.height();}return fold<=$(element).offset().top-settings.threshold;};$.rightoffold=function(element,settings){var fold;if(settings.container===undefined||settings.container===window){fold=$window.width()+$window.scrollLeft();}else{fold=$container.offset().left+$container.width();}return fold<=$(element).offset().left-settings.threshold;};$.abovethetop=function(element,settings){var fold;if(settings.container===undefined||settings.container===window){fold=$window.scrollTop();}else{fold=$container.offset().top;}return fold>=$(element).offset().top+settings.threshold+$(element).height();};$.leftofbegin=function(element,settings){var fold;if(settings.container===undefined||settings.container===window){fold=$window.scrollLeft();}else{fold=$container.offset().left;}return fold>=$(element).offset().left+settings.threshold+$(element).width();};$.inviewport=function(element,settings){return !$.rightofscreen(element,settings)&&!$.leftofscreen(element,settings)&&!$.belowthefold(element,settings)&&!$.abovethetop(element,settings);};$.extend($.expr[":"],{"below-the-fold":function(a){return $.belowthefold(a,{threshold:0,container:window});},"above-the-top":function(a){return !$.belowthefold(a,{threshold:0,container:window});},"right-of-screen":function(a){return $.rightoffold(a,{threshold:0,container:window});},"left-of-screen":function(a){return !$.rightoffold(a,{threshold:0,container:window});},"in-viewport":function(a){return !$.inviewport(a,{threshold:0,container:window});},"above-the-fold":function(a){return !$.belowthefold(a,{threshold:0,container:window});},"right-of-fold":function(a){return $.rightoffold(a,{threshold:0,container:window});},"left-of-fold":function(a){return !$.rightoffold(a,{threshold:0,container:window});}});})(jQuery,window);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.modules.CheckboxFilter",CheckboxFilter);Pattern.extend(CheckboxFilter);function CheckboxFilter(setup){setup=setup||{};this.elements={wrapper:setup.wrapper};this.defaultValue=setup.defaultValue||false;this._eventHandlers={};this._eventNames={change:"change"};}CheckboxFilter.prototype._cacheElements=function(){this.$wrapper=$(this.elements.wrapper);this.$checkbox=this.$wrapper.find(".checkbox-filter");this.$label=this.$wrapper.find(".checkbox-filter-label");};CheckboxFilter.prototype._bindEvents=function(){this.$checkbox.on("change",this._events.changeCheckbox.bind(this));};CheckboxFilter.prototype._events={changeCheckbox:function(e){this.trigger(this._eventNames.change,{target:this});}};CheckboxFilter.prototype.getSerializedData=function(){return{key:this.$checkbox.attr("name"),value:this.$checkbox.prop("checked")?this.$checkbox.val():""};};CheckboxFilter.prototype.getId=function(){return this.$wrapper.attr("data-checkbox-filter");};CheckboxFilter.prototype.getValue=function(){return this.$checkbox.val();};CheckboxFilter.prototype.getTextValue=function(){return this.$label.text().trim();};CheckboxFilter.prototype.getText=function(){return this.getTextValue();};CheckboxFilter.prototype.isDefaultValue=function(){return this.$checkbox.prop("checked")===this.defaultValue;};CheckboxFilter.prototype.isVisible=function(){return this.$wrapper.is(":visible");};CheckboxFilter.prototype.resetValue=function(){this.setChecked(this.defaultValue);};CheckboxFilter.prototype.getType=function(){return"checkbox";};CheckboxFilter.prototype.isChecked=function(){return this.$checkbox.is(":checked");};CheckboxFilter.prototype.setChecked=function(checked,notTriggered){this.$checkbox.prop("checked",checked);if(this.isChecked()){this.$checkbox.addClass("checked");}else{this.$checkbox.removeClass("checked");}if(!notTriggered){this.trigger(this._eventNames.change,{target:this});}};CheckboxFilter.prototype.disableForForm=function(){return this.$checkbox.attr("disabled",true);};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.modules.InputFilter",InputFilter);Pattern.extend(InputFilter);function InputFilter(setup){setup=setup||{};this.elements={wrapper:setup.wrapper};this.defaultValue=setup.defaultValue||"";this._eventHandlers={};this._eventNames={change:"change"};}InputFilter.prototype._cacheElements=function(){this.$wrapper=$(this.elements.wrapper);this.$input=this.$wrapper.find("#search-block-query-input");this.$clearValueButton=this.$wrapper.find(".search-block-input-clear");};InputFilter.prototype._bindEvents=function(){this.$input.on("keyup",this._events.changeInputText.bind(this));this.$input.on("focusin",this._events.inputFocusIn.bind(this));this.$input.on("focusout",this._events.inputFocusOut.bind(this));if(this.$clearValueButton){this.$clearValueButton.on("mousedown",this._events.clearInputClick.bind(this));}};InputFilter.prototype._events={changeInputText:function(e){if(this.$clearValueButton){if(this.$input.val()){this.$clearValueButton.show();}else{this.$clearValueButton.hide();}}this.trigger(this._eventNames.change,{target:this});},inputFocusIn:function(e){if(this.$clearValueButton){if(this.$input.val()){this.$clearValueButton.show();}else{this.$clearValueButton.hide();}}},inputFocusOut:function(e){if(this.$clearValueButton){this.$clearValueButton.hide();}},clearInputClick:function(e){this.$input.val("").focus();}};InputFilter.prototype.getSerializedData=function(){return{key:this.$input.attr("name"),value:this.$input.val()};};InputFilter.prototype.getId=function(){return this.$wrapper.attr("data-input-filter");};InputFilter.prototype.getValue=function(){return this.$input.val();};InputFilter.prototype.getTextValue=function(){return this.getValue();};InputFilter.prototype.getText=function(){var text="";var name=this.$wrapper.attr("data-name-for-tag").trim();if(name){text=name+": ";}text+=this.getTextValue();return text;};InputFilter.prototype.isDefaultValue=function(){return this.$input.val()==="";};InputFilter.prototype.isVisible=function(){return this.$wrapper.is(":visible");};InputFilter.prototype.resetValue=function(){this.$input.val(this.defaultValue);this.trigger(this._eventNames.change,{target:this});};InputFilter.prototype.getType=function(){return"text";};InputFilter.prototype.disableForForm=function(){this.$input.css({background:"#fff"}).attr("disabled",true);};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.modules.RadioFilter",RadioFilter);Pattern.extend(RadioFilter);function RadioFilter(setup){setup=setup||{};this.elements={wrapper:setup.wrapper};this.defaultValue=setup.defaultValue||0;this._eventHandlers={};this._eventNames={change:"change"};}RadioFilter.prototype._cacheElements=function(){this.$wrapper=$(this.elements.wrapper);this.$radio=this.$wrapper.find(".radio-filter");this.$label=this.$wrapper.find(".radio-filter-label");};RadioFilter.prototype._bindEvents=function(){this.$radio.on("change",this._events.changeRadio.bind(this));};RadioFilter.prototype._events={changeRadio:function(e){this.trigger(this._eventNames.change,{target:this});}};RadioFilter.prototype.getSerializedData=function(){return{key:this.$radio.attr("name"),value:this.$radio.filter(":checked").val()};};RadioFilter.prototype.getId=function(){return this.$wrapper.attr("data-radio-filter");};RadioFilter.prototype.getValue=function(){return this.$radio.filter(":checked").val();};RadioFilter.prototype.getTextValue=function(){return this.$radio.filter(":checked").next().text();};RadioFilter.prototype.getText=function(){return this.getTextValue();};RadioFilter.prototype.isDefaultValue=function(){return this.defaultValue?this.$radio.filter("[value="+this.defaultValue+"]").prop("checked"):this.$radio.eq(this.defaultValue).prop("checked");};RadioFilter.prototype.isVisible=function(){return this.$wrapper.is(":visible");};RadioFilter.prototype.resetValue=function(){this.defaultValue?this.$radio.filter("[value="+this.defaultValue+"]").prop("checked",true):this.$radio.eq(this.defaultValue).prop("checked",true);this.trigger(this._eventNames.change,{target:this});};RadioFilter.prototype.getType=function(){return"radio";};RadioFilter.prototype.disableForForm=function(){this.$radio.attr("disabled",true);};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.modules.RangeFilter",RangeFilter);Pattern.extend(RangeFilter);function RangeFilter(setup){setup=setup||{};this.elements={wrapper:setup.wrapper};this.defaultValue=setup.defaultValue||["",""];this.fieldData={from:{value:null,maxLength:null},to:{value:null,maxLength:null}};this._eventHandlers={};this._eventNames={change:"change"};}RangeFilter.prototype._cacheElements=function(){this.$wrapper=$(this.elements.wrapper);this.$fromField=this.$wrapper.find(".range-filter-from");this.$toField=this.$wrapper.find(".range-filter-to");};RangeFilter.prototype._bindEvents=function(){this.$fromField.add(this.$toField).on("keydown keyup focusin",this._events.changeField.bind(this));};RangeFilter.prototype._events={changeField:function(e){var $field=$(e.target),value=$field.val(),data=$field.is(this.$fromField)?this.fieldData.from:this.fieldData.to;if(e.type==="keydown"||e.type==="focusin"){data.value=value;}if(e.type==="keyup"&&data.value!==value){this.format($field);data.value=value;}if(!$field.attr("maxlength")){return;}if(!data.maxLength){data.maxLength=+$field.attr("maxlength");}var currentMaxLength=/\./.test(value)?value.split(".")[0].length-1:data.maxLength;$field.attr("maxlength",currentMaxLength>0?data.maxLength+Math.ceil(currentMaxLength/3)-1:data.maxLength);}};RangeFilter.prototype.format=function($field){var caretPosition=$field.getCaretPosition(),beforeLength=$field.val().length,formatted=utils.Common.numberToPrice($field.val().replace(/\s+/g,""));$field.val(formatted);$field.setCaretPosition(formatted.length>beforeLength?formatted.length-beforeLength+caretPosition:formatted.length<beforeLength?caretPosition-(beforeLength-formatted.length):caretPosition);this.trigger(this._eventNames.change,{target:this});};RangeFilter.prototype.getSerializedData=function(){return[{key:this.$fromField.attr("name"),value:this.$fromField.val()},{key:this.$toField.attr("name"),value:this.$toField.val()}];};RangeFilter.prototype.getId=function(){return this.$wrapper.attr("data-range-filter");};RangeFilter.prototype.getValue=function(){return[this.$fromField.val(),this.$toField.val()];};RangeFilter.prototype.getTextValue=function(){return this.getValue();};RangeFilter.prototype.getText=function(){var text="";var name=this.$wrapper.attr("data-name-for-tag").trim();if(name){text=name+": ";}var from=this.$fromField.val().trim();if(from){text+="от "+from;}var to=this.$toField.val().trim();if(to){if(from){text+=" ";}text+="до "+to;}var suffix=this.$wrapper.attr("data-suffix-for-tag");if(suffix){text+=" "+suffix;}return text;};RangeFilter.prototype.isDefaultValue=function(){return this.$fromField.val().trim()===this.defaultValue[0]&&this.$toField.val().trim()===this.defaultValue[1];};RangeFilter.prototype.isVisible=function(){return this.$wrapper.is(":visible");};RangeFilter.prototype.resetValue=function(){this.$fromField.val(this.defaultValue[0]);this.$toField.val(this.defaultValue[1]);this.trigger(this._eventNames.change,{target:this});};RangeFilter.prototype.disableForForm=function(){this.$fromField.css({background:"#fff"}).attr("disabled",true);this.$toField.css({background:"#fff"}).attr("disabled",true);};RangeFilter.prototype.getType=function(){return"text";};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.modules.SelectFilter",SelectFilter);Pattern.extend(SelectFilter);function SelectFilter(setup){setup=setup||{};this.elements={wrapper:setup.wrapper};this.defaultValue=setup.defaultValue||"";this.lastValue="";this._eventHandlers={};this._eventNames={add:"add",change:"change"};}SelectFilter.prototype._cacheElements=function(){this.$wrapper=$(this.elements.wrapper);this.$select=this.$wrapper.find(".select-filter");};SelectFilter.prototype._bindEvents=function(){this.$select.on("change",this._events.changeSelect.bind(this));};SelectFilter.prototype._ready=function(){this.lastValue=this.getValue();};SelectFilter.prototype._events={changeSelect:function(e){var currentValue=this.getValue();if(this.lastValue!==currentValue){this.lastValue=currentValue;this.trigger(this._eventNames.change,{target:this});}}};SelectFilter.prototype.getSerializedData=function(){return{key:this.$select.attr("name"),value:this.$select.val()};};SelectFilter.prototype.getId=function(){return this.$wrapper.attr("data-select-filter");};SelectFilter.prototype.getValue=function(){return this.$select?this.$select.val()||"":null;};SelectFilter.prototype.setValue=function(value,dontTriggerEvent){if(ie!==8){this.$select.multipleSelect("setSelects",value);}if(!dontTriggerEvent){this.trigger(this._eventNames.change,{target:this});}};SelectFilter.prototype.getTextValue=function(){var selected=this.$select.find(":selected");if(!selected||selected.length===0){return"";}else{if(selected.length<3){var text="";ld(selected).forEach(function(obj){if(text){text+=", ";}text+=$(obj).text().trim();});var suffix=this.$wrapper.attr("data-suffix-for-tag");if(suffix){text+=" "+suffix;}return text;}else{return selected.length+" из "+this.$select.multipleSelect("getItemsCount");}}};SelectFilter.prototype.getText=function(){var text="";var name=this.$wrapper.attr("data-name-for-tag").trim();if(name){text=name+": ";}return text+this.getTextValue();};SelectFilter.prototype.isDefaultValue=function(){var value=this.$select.val();if(this.defaultValue){if(typeof value=="string"||value instanceof String){return value.trim()===this.defaultValue;}else{return value&&value.length===1&&value[0].trim()===this.defaultValue;}}else{return !value||value.length===0||this.$select.find("option:first-child").prop("selected");}};SelectFilter.prototype.isVisible=function(){return this.$wrapper.is(":visible");};SelectFilter.prototype.resetValue=function(){this.defaultValue?this.$select.val(this.defaultValue):this.$select.val([]);if(ie!==8){this.$select.multipleSelect("refresh");}this.trigger(this._eventNames.change,{target:this});};SelectFilter.prototype.getDefaultValue=function(){return this.defaultValue?this.$select.find("option").filter(ld.template('[value="${value}"]',{value:this.defaultValue})):this.$select.find("option").eq(this.defaultValue);};SelectFilter.prototype.clear=function(isAll){if(isAll){return this.$select.empty();}this.$select.find("option").not(this.getDefaultValue()).remove();};SelectFilter.prototype.addItem=function(){if(!arguments.length){return;}var args=Array.prototype.slice.call(arguments);switch(arguments.length){case 1:this.$select.append($("<option></option>").text(args[0]));break;case 2:this.$select.append($("<option></option>").attr("value",args[0]).text(args[1]));break;}if(ie!==8){this.$select.multipleSelect("refresh");}this.trigger(this._eventNames.add,{target:this});};SelectFilter.prototype.show=function(){this.$wrapper.show();};SelectFilter.prototype.hide=function(){this.$wrapper.hide();};SelectFilter.prototype.enable=function(){if(ie!==8){this.$select.multipleSelect("enable");}};SelectFilter.prototype.disable=function(){if(ie!==8){this.$select.multipleSelect("disable");}};SelectFilter.prototype.disableForForm=function(){if(ie!==8){this.$select.multipleSelect("disableForForm");}};SelectFilter.prototype.close=function(){if(ie!==8){this.$select.multipleSelect("isOpen")&&this.$select.multipleSelect("close");}};SelectFilter.prototype.resetValues=function(html){this.$select.find("option").remove();this.$select.html(html);if(ie!==8){this.$select.multipleSelect("refresh");}this.setValue([this.lastValue],true);this.trigger(this._eventNames.change,{target:this});};SelectFilter.prototype.getType=function(){return"select";};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.modules.SelectGroupFilter",SelectGroupFilter);Pattern.extend(SelectGroupFilter);function SelectGroupFilter(setup){setup=setup||{};this.elements={wrapper:setup.wrapper};this.defaultValue=setup.defaultValue||"";this.lastValue="";this._eventHandlers={};this._eventNames={change:"change"};}SelectGroupFilter.prototype._cacheElements=function(){this.$wrapper=$(this.elements.wrapper);this.$selectGroup=this.$wrapper.find(".select-group-filter");};SelectGroupFilter.prototype._bindEvents=function(){this.$selectGroup.on("change",this._events.changeSelectGroup.bind(this));};SelectGroupFilter.prototype._events={changeSelectGroup:function(e){var currentValue=this.getValue();if(this.lastValue!==currentValue){this.lastValue=currentValue;this.trigger(this._eventNames.change,{target:this});}}};SelectGroupFilter.prototype.getSerializedData=function(){return{key:this.$selectGroup.attr("name"),value:this.$selectGroup.val()};};SelectGroupFilter.prototype.getId=function(){return this.$wrapper.attr("data-select-group-filter");};SelectGroupFilter.prototype.getValue=function(){return this.$selectGroup.val()||"";};SelectGroupFilter.prototype.setValue=function(value){if(ie!==8){this.$selectGroup.multipleSelect("setSelects",value);}this.trigger(this._eventNames.change,{target:this});};SelectGroupFilter.prototype.getTextValue=function(){var selected=this.$selectGroup.find(":selected");if(!selected||selected.length===0){return"";}else{if(selected.length<3){var text="";ld(selected).forEach(function(obj){if(text){text+=", ";}text+=$(obj).text().trim();});var suffix=this.$wrapper.attr("data-suffix-for-tag");if(suffix){text+=" "+suffix;}return text;}else{return selected.length+" из "+this.$selectGroup.multipleSelect("getItemsCount");}}};SelectGroupFilter.prototype.getText=function(){var text="";var name=this.$wrapper.attr("data-name-for-tag").trim();if(name){text=name+": ";}return text+this.getTextValue();};SelectGroupFilter.prototype.isDefaultValue=function(){return this.defaultValue?(this.$selectGroup.val()||[]).length===1&&this.$selectGroup.val()[0].trim()===this.defaultValue:!this.$selectGroup.val()||this.$selectGroup.val().length===0||this.$selectGroup.find("option:first-child").prop("selected");};SelectGroupFilter.prototype.isVisible=function(){return this.$wrapper.is(":visible");};SelectGroupFilter.prototype.resetValue=function(){this.defaultValue?this.$selectGroup.val(this.defaultValue):this.$selectGroup.val([]);if(ie!==8){this.$selectGroup.multipleSelect("refresh");}this.trigger(this._eventNames.change,{target:this});};SelectGroupFilter.prototype.close=function(){if(ie!==8){this.$selectGroup.multipleSelect("isOpen")&&this.$selectGroup.multipleSelect("close");}};SelectGroupFilter.prototype.disableForForm=function(){if(ie!==8){this.$selectGroup.multipleSelect("disableForForm");}};SelectGroupFilter.prototype.disable=function(){if(ie!==8){this.$selectGroup.multipleSelect("disable");}};SelectGroupFilter.prototype.getType=function(){return"select";};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.modules.SelectRangeFilter",SelectRangeFilter);Pattern.extend(SelectRangeFilter);function SelectRangeFilter(setup){setup=setup||{};this.elements={wrapper:setup.wrapper};this.defaultValue=setup.defaultValue||["",""];this._eventHandlers={};this._eventNames={change:"change"};}SelectRangeFilter.prototype._cacheElements=function(){this.$wrapper=$(this.elements.wrapper);this.$fromField=this.$wrapper.find(".select-range-filter-from");this.$toField=this.$wrapper.find(".select-range-filter-to");};SelectRangeFilter.prototype._bindEvents=function(){this.$fromField.add(this.$toField).on("change",this._events.changeField.bind(this));};SelectRangeFilter.prototype._events={changeField:function(e){this.trigger(this._eventNames.change,{target:this});}};SelectRangeFilter.prototype.getSerializedData=function(){return[{key:this.$fromField.attr("name"),value:this.$fromField.val()},{key:this.$toField.attr("name"),value:this.$toField.val()}];};SelectRangeFilter.prototype.getId=function(){return this.$wrapper.attr("data-select-range-filter");};SelectRangeFilter.prototype.getValue=function(){return[this.$fromField.val()||"",this.$toField.val()||""];};SelectRangeFilter.prototype.getTextValue=function(){return this.getValue();};SelectRangeFilter.prototype.getText=function(){var text="";var name=this.$wrapper.attr("data-name-for-tag").trim();if(name){text=name+": ";}var from=(this.$fromField.val()||"").trim();if(from){text+="от "+from;}var to=(this.$toField.val()||"").trim();if(to){if(from){text+=" ";}text+="до "+to;}var suffix=this.$wrapper.attr("data-suffix-for-tag");if(suffix){text+=" "+suffix;}return text;};SelectRangeFilter.prototype.isDefaultValue=function(){var isFromFieldDefault=this.defaultValue[0]?this.$fromField.val()&&this.$fromField.val().trim()===this.defaultValue[0]:!this.$fromField.val()||this.$fromField.find("option:first-child").prop("selected"),isToFieldDefault=this.defaultValue[1]?this.$toField.val()&&this.$toField.val().trim()===this.defaultValue[1]:!this.$toField.val()||this.$toField.find("option:first-child").prop("selected");return isFromFieldDefault&&isToFieldDefault;};SelectRangeFilter.prototype.isVisible=function(){return this.$wrapper.is(":visible");};SelectRangeFilter.prototype.resetValue=function(){this.defaultValue[0]?this.$fromField.val(this.defaultValue[0]):this.$fromField.find("option").eq(this.defaultValue[0]).prop("selected",true);if(ie!==8){this.$fromField.multipleSelect("refresh");}this.defaultValue[1]?this.$toField.val(this.defaultValue[1]):this.$toField.find("option").eq(this.defaultValue[1]).prop("selected",true);if(ie!==8){this.$toField.multipleSelect("refresh");}this.trigger(this._eventNames.change,{target:this});};SelectRangeFilter.prototype.close=function(){if(ie!==8){this.$fromField.multipleSelect("isOpen")&&this.$fromField.multipleSelect("close");this.$toField.multipleSelect("isOpen")&&this.$toField.multipleSelect("close");}};SelectRangeFilter.prototype.disableForForm=function(){if(ie!==8){this.$fromField.multipleSelect("disableForForm");this.$toField.multipleSelect("disableForForm");}};SelectRangeFilter.prototype.disable=function(){if(ie!==8){this.$fromField.multipleSelect("disable");this.$toField.multipleSelect("disable");}};SelectRangeFilter.prototype.getType=function(){return"select";};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.modules.Dialog",Dialog);Pattern.extend(Dialog);function Dialog(setup){setup=setup||{};this.content=setup.content;this.message=setup.message||"";this.className=setup.className||"";this.options={autoOpen:false,modal:true,resizable:false,title:setup.title||"Внимание",width:setup.width||520,buttons:(setup.hasCloseButton||false)?{"Закрыть":function(){$(this).dialog("close");}}:{}};this._eventHandlers={};this._eventNames={open:"open",close:"close"};}Dialog.prototype._cacheElements=function(){this.$dialog=this.content?$(this.content).dialog(this.options):$(document.createElement("div")).addClass(this.className).text(this.message).appendTo("body").dialog(this.options);};Dialog.prototype._bindEvents=function(){this.$dialog.on("dialogopen",this._events.openDialog.bind(this));this.$dialog.on("dialogclose",this._events.closeDialog.bind(this));};Dialog.prototype._events={openDialog:function(){this.$dialog.find(":input:visible:first").focus();this.trigger(this._eventNames.open);},closeDialog:function(){this.trigger(this._eventNames.close);}};Dialog.prototype.setContent=function(className,message){this.$dialog.dialog("destroy").removeClass().addClass(className).text(message).dialog(this.options);};Dialog.prototype.open=function(){this.$dialog.dialog("open");};Dialog.prototype.close=function(){this.$dialog.dialog("close");};Dialog.prototype.destroy=function(){this.$dialog.remove();};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.modules.Spinner",Spinner);Pattern.extend(Spinner);function Spinner(setup){setup=setup||{};this.target=setup.target;this.src=setup.src||"/img/load_indicator.gif";this.visible=setup.visible||false;this.position=setup.position||"center";this.top=setup.top;this.left=setup.left;this.style="display: ${display}; position: absolute;";this._eventHandlers={};this._eventNames={show:"show",hide:"hide"};}Spinner.prototype._cacheElements=function(){this.$target=$(this.target);this.$spinner=$("<img>",{src:this.src});};Spinner.prototype._ready=function(){this.prepare();};Spinner.prototype.calculateOffset=function(position){switch(position){case"center":return{top:this.$target.outerHeight(true)/2-this.$spinner.height()/2,left:this.$target.outerWidth(true)/2-this.$spinner.width()/2};case"top-left":return{top:0,left:0};case"top-right":return{top:0,left:this.$target.outerWidth(true)-this.$spinner.width()};case"bottom-left":return{top:this.$target.outerHeight(true)-this.$spinner.height(),left:0};case"bottom-right":return{top:this.$target.outerHeight(true)-this.$spinner.height(),left:this.$target.outerWidth(true)-this.$spinner.height()};default:return{top:this.$target.outerHeight(true)/2-this.$spinner.height()/2,left:this.$target.outerWidth(true)/2-this.$spinner.width()/2};}};Spinner.prototype.prepare=function(){if(!this.$target.find(this.$spinner).length){this.$target.css({position:"relative"});this.$target.append(this.$spinner);this.$spinner.attr("style",ld.template(this.style,{display:this.visible?"inline-block":"none"}));}this.$spinner.css({top:this.top||this.calculateOffset(this.position).top,left:this.left||this.calculateOffset(this.position).left});};Spinner.prototype.show=function(duration,callback){this.prepare();duration?this.$spinner.fadeIn(duration,callback):this.$spinner.show();this.trigger(this._eventNames.show);};Spinner.prototype.hide=function(duration,callback){if(duration&&this.$spinner.is(":visible")){this.$spinner.fadeOut(duration,callback);}else{this.$spinner.css({display:"none"});ld.isFunction(callback)&&callback();}this.trigger(this._eventNames.hide);};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.modules.TagsPanel",TagsPanel);Pattern.extend(TagsPanel);function TagsPanel(setup){setup=setup||{};this.elements={wrapper:setup.wrapper};this.additionalTags=setup.additionalTags;this.customValues=setup.customValues||{};this.tags={};this.blankTag='<div class="tags-panel-tag">'+'<span class="tags-panel-tag-name">${name}</span>'+'<div class="tags-panel-tag-remove-button search-block-turn-off-icon" data-tags-panel-tag-id="${id}"></div>'+"</div>";this._eventHandlers={};this._eventNames={add:"add",clear:"clear",rename:"rename",remove:"remove",show:"show"};}TagsPanel.prototype._cacheElements=function(){this.$wrapper=$(this.elements.wrapper);this.$content=this.$wrapper.find(".tags-panel-content");this.$clearButton=this.$wrapper.find(".tags-panel-clear");};TagsPanel.prototype._bindEvents=function(){this.$content.on("click",".tags-panel-tag-remove-button",this._events.clickRemoveButton.bind(this));this.$clearButton.on("click",this._events.clickClearButton.bind(this));};TagsPanel.prototype._events={clickRemoveButton:function(e){this.remove($(e.target).attr("data-tags-panel-tag-id"));},clickClearButton:function(){this.clear();}};TagsPanel.prototype._ready=function(){if(this.additionalTags&&this.additionalTags.length>0){ld(this.additionalTags).forEach(function(tag){this.add(tag.id,tag.name);}.bind(this));}};TagsPanel.prototype.show=function(){this.$wrapper.find(".tags-panel-wrapper").show();this.trigger(this._eventNames.show);};TagsPanel.prototype.hide=function(){this.$wrapper.find(".tags-panel-wrapper").hide();};TagsPanel.prototype.add=function(id,name,animated){if(this.isExists(id)){return this.rename(id,name);}if(this.customValues[id]){name=htmlDecode(this.customValues[id]);this.customValues[id]="";}var tag=$(ld.template(this.blankTag,{id:id,name:name})).hide();this.tags[id]=tag.appendTo(this.$content);tag.fadeIn(animated&&this.$wrapper.is(":visible")?300:0);this.trigger(this._eventNames.add);};TagsPanel.prototype.rename=function(id,name){this.tags[id].find(".tags-panel-tag-name").text(name);this.trigger(this._eventNames.rename);};TagsPanel.prototype.remove=function(id){if(!this.isExists(id)){return;}this.tags[id].fadeOut(300,function(){this.tags[id]&&this.tags[id].remove();delete this.tags[id];this.trigger(this._eventNames.remove,{data:{id:id}});}.bind(this));};TagsPanel.prototype.clear=function(){this.reset();this.trigger(this._eventNames.clear);};TagsPanel.prototype.reset=function(){this.$content.empty();this.tags={};};TagsPanel.prototype.isEmpty=function(){return ld.isEmpty(this.tags);};TagsPanel.prototype.isExists=function(id){return this.tags.hasOwnProperty(id);};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,widgets,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.layouts.FiltersManager",FiltersManager);Pattern.extend(FiltersManager);function FiltersManager(setup){setup=setup||{};this.ajaxParams=setup.ajaxParams;this.dependencies=setup.dependencies;this.isAdsRubric=setup.isAdsRubric;this.locationManagerSetup=setup.locationManager||{};this.searchAreaManager=setup.searchAreaManager;this.timeouts={};this.filters={};this.selectedFiltersValues={};this.serializedData={};this.specialFiltersOpened=false;this.toggleSpecialWidth=-1;this.lastUpdateFilteredAdsAmountRequest=null;this.savedRubricParams={};this._eventHandlers={};this._eventNames={apply:"apply",change:"change",closeLocationDialog:"closeLocationDialog",hide:"hide",progressUpdateAmount:"progressUpdateAmount",update:"update",changeSearchArea:"changeSearchArea"};}FiltersManager.prototype._cacheElements=function(){this.$wrapper=$("#search-block-filters");this.$document=$(global.document);this._cacheSearchPanelElements();this._cacheFiltersPanelElements();};FiltersManager.prototype._cacheSearchPanelElements=function(){this.$rubricParam=$('input[name="rubric"]');this.$filtersForm=$("#filtersForm");this.$queryField=$("#search-block-query-input");this.$searchAreaValue=$("#searchAreaValue");this.$submitButton=this.$filtersForm.find(".search-block-apply");this.$detailFiltersBlock=$(".filters-manager-filters-block");};FiltersManager.prototype._cacheFiltersPanelElements=function(){this.$toggleSpecialFilters=this.$wrapper.find(".ads-filters-switch-wrapper");this.$toggleSpecialFiltersSpan=this.$toggleSpecialFilters.find("#ads-filters-switch");this.$specialFiltersBlock=this.$wrapper.find(".search-block-special");this.$specialFiltersBlockBorder=this.$wrapper.find(".search-block-special-border");this.$amountBox=$("div.ads-filters-amount-box");this.$amountPhrase=this.$amountBox.find("span.ads-filters-amount-phrase");this.$filteredAdsCounter=this.$amountBox.find("span.ads-filters-amount");this.$checkboxFilters=this.$wrapper.find("div[data-checkbox-filter]");this.$selectFilters=this.$wrapper.find("div[data-select-filter]");this.$selectGroupFilters=this.$wrapper.find("div[data-select-group-filter]");this.$selectRangeFilters=this.$wrapper.find("div[data-select-range-filter]");this.$radioFilters=this.$wrapper.find("div[data-radio-filter]");this.$rangeFilters=this.$wrapper.find("div[data-range-filter]");this.$inputFilters=this.$wrapper.find("div[data-input-filter]");this.$locationTrigger=this.$wrapper.find("div.ads-filters-location-toggle");this.$searchAreaManagerToggle=this.$wrapper.find(".sam-toggle.ms-parent");this.$selectedLocation=this.$locationTrigger.find("span.ads-filters-selected-location");this.$constFiltersBlock=$(".ads-filters-const");};FiltersManager.prototype._createWidgets=function(){this._createSearchPanelWidgets();this._createFiltersPanelWidgets();this.spinner=new widgets.modules.Spinner({target:this.$wrapper});};FiltersManager.prototype._createSearchPanelWidgets=function(){this.locationManager=new widgets.layouts.LocationManager(this.locationManagerSetup);};FiltersManager.prototype._createFiltersPanelWidgets=function(){this._includeModule(this.$checkboxFilters,"data-checkbox-filter","CheckboxFilter");this._includeModule(this.$selectFilters,"data-select-filter","SelectFilter");this._includeModule(this.$selectGroupFilters,"data-select-group-filter","SelectGroupFilter");this._includeModule(this.$selectRangeFilters,"data-select-range-filter","SelectRangeFilter");this._includeModule(this.$radioFilters,"data-radio-filter","RadioFilter");this._includeModule(this.$rangeFilters,"data-range-filter","RangeFilter");this._includeModule(this.$inputFilters,"data-input-filter","InputFilter");this.amountSpinner=new widgets.modules.Spinner({target:this.$amountBox,top:"5px"});};FiltersManager.prototype._includeModule=function($elements,dataAttr,moduleName){$elements.each(function(index,element){this.filters[element.getAttribute(dataAttr)]=new widgets.modules[moduleName]({wrapper:element,defaultValue:element.getAttribute("data-default-value")});}.bind(this));};FiltersManager.prototype._bindEvents=function(){this.$document.on("click",this._events.clickOut.bind(this));this._bindSearchPanelEvents();this._bindFiltersPanelEvents();};FiltersManager.prototype._bindSearchPanelEvents=function(){this.$submitButton.on("click",this._events.submit.bind(this));this.locationManager.on("apply",this._events.applyLocationManager,this);this.$locationTrigger.on("click",this._events.clickLocationTrigger.bind(this));this.$queryField.on("keypress",this._events.queryInputKeyPressed.bind(this));this.searchAreaManager.on("apply",this._events.changeSearchArea.bind(this));this.$searchAreaManagerToggle.on("click",this._events.searchAreaManagerToggleClick.bind(this));};FiltersManager.prototype._bindFiltersPanelEvents=function(){ld(this.filters).forEach(function(filter,name){var handler;switch(name){case"type":handler=this._events.changeAdType;break;case"query":handler=this._events.changeSearchQueryField;break;case"cityDistrict":handler=this._events.changeCityDistrict;break;default:handler=this._events.changeFilter;break;}filter.on("change",handler,this);},this);this.$toggleSpecialFilters.on("click",this._events.toggleSpecialFilters.bind(this));};FiltersManager.prototype._events={clickOut:function(){this.locationManager.close();this.searchAreaManager.close();},submit:function(){ld(this.filters).forEach(function(filter){if(filter.isDefaultValue()){filter.disableForForm();}}.bind(this));this.$filtersForm.find(".ms-parent input").attr("disabled",true);},queryInputKeyPressed:function(e){if(e.which==13){this.$filtersForm.submit();}},applyLocationManager:function(e){if(this.filters["abroad"]){this.filters["abroad"].setChecked(e.data.abroad||false,true);}if(this.locationManager.hasDistricts()){this._syncDistrictsFilter();}else{if(this.filters.cityDistrict&&this.filters.cityDistrict.isVisible()){this.filters.cityDistrict.clear();this.filters.cityDistrict.hide();}}this.updateSerializedData(e.target.getSerializedData());this.updateFilteredAdsAmount();this.updateSelectedLocation();this.trigger(this._eventNames.closeLocationDialog,{data:{region:e.data.region.value?e.data.region.text:"",locality:e.data.locality.value?e.data.locality.text:"",changed:true}});},searchAreaManagerToggleClick:function(e){e.stopPropagation();this.searchAreaManager.toggle();this.locationManager.close();this._closeSelectFilters();},clickLocationTrigger:function(e){e.stopPropagation();this.locationManager.toggle();this.searchAreaManager.close();this._closeSelectFilters();},changeSearchQueryField:function(e){this.updateSerializedData(e.target.getSerializedData());this._deferExec(e.target.getId(),this.updateFilteredAdsAmount);this.updateDependenciesFilters(e.target);this.trigger(this._eventNames.change,{target:this,data:{id:e.target.getId(),content:e.target.getText(),isDefaultValue:e.target.isDefaultValue()}});},changeFilter:function(e){this.updateSerializedData(e.target.getSerializedData());this.updateFilteredAdsAmount();this.updateDependenciesFilters(e.target);ld(this.$filtersForm.serializeArray()).forEach(function(filter){this.selectedFiltersValues[filter.name]=filter.value;}.bind(this));this.trigger(this._eventNames.change,{target:this,data:{id:e.target.getId(),content:e.target.getText(),isDefaultValue:e.target.isDefaultValue()}});},toggleSpecialFilters:function(){if(!this.specialFiltersToggling){this.specialFiltersToggling=true;if(this.$specialFiltersBlock.hasClass("search-block-special-off")){if(!this.specialFiltersOpened){this.$specialFiltersBlockBorder.css({opacity:0});}this.$specialFiltersBlock.addClass("search-block-special-on").removeClass("search-block-special-off");if(!this.specialFiltersOpened){var height=this.$specialFiltersBlockBorder.height();this.$specialFiltersBlockBorder.css({height:1,opacity:1}).show().animate({height:height},500,function(){this.$toggleSpecialFilters.addClass("ads-filters-switch-close").removeClass("ads-filters-switch-open");this.$toggleSpecialFiltersSpan.text("Свернуть");this.specialFiltersOpened=true;this.specialFiltersToggling=false;}.bind(this));}else{this.specialFiltersToggling=false;}}else{this.$specialFiltersBlockBorder.animate({height:0},200,function(){this.$specialFiltersBlockBorder.hide();this.$specialFiltersBlock.slideUp(90,function(){this.$specialFiltersBlock.addClass("search-block-special-off").removeClass("search-block-special-on").show();this.$specialFiltersBlockBorder.css({height:""});this.$toggleSpecialFilters.addClass("ads-filters-switch-open").removeClass("ads-filters-switch-close");this.$toggleSpecialFiltersSpan.text("Все фильтры");this.specialFiltersOpened=false;this.specialFiltersToggling=false;}.bind(this));}.bind(this));}}},changeAdType:function(){this.updateSelectedFiltersValues();this.updateFilters(this.selectedFiltersValues,function(html){this.amountSpinner.hide();this.$detailFiltersBlock.html(this._removeFormFromFiltersHTML(html));this._cacheFiltersPanelElements();this._createFiltersPanelWidgets();this._bindFiltersPanelEvents();this._readyFiltersPanel();this.updateFilteredAdsAmount();this.trigger(this._eventNames.update,this._generateDataForUpdateEvent());},this);},changeCityDistrict:function(e){this.locationManager.setDistrict(this.filters.cityDistrict.getValue());this._events.changeFilter.call(this,e);},changeSearchArea:function(){var value=this.searchAreaManager.getValue(),rubric=this.searchAreaManager.getRubric();this.$searchAreaValue.html(value.name);this.$rubricParam.attr("value",rubric.id||"");this.changePath();if(value.action!=="/ads"){this.$filtersForm.submit();}else{this.isAdsRubric=true;this.$queryField.removeClass("search-block-query-input-without-location").addClass("search-block-query-input-with-location");this.$locationTrigger.show();this.spinner.show(200);this.$detailFiltersBlock.animate({opacity:0},200);this.updateFilters(ld.assign({rubric:rubric.id},this.savedRubricParams[rubric.id]),function(html){this.locationManager.setRubric(rubric.id);this.locationManager.updateDistrict(function(){if(this.locationManager.hasDistricts()){this._syncDistrictsFilter();}else{if(this.filters.cityDistrict&&this.filters.cityDistrict.isVisible()){this.filters.cityDistrict.clear();this.filters.cityDistrict.hide();}}},this);this.amountSpinner.hide();this.$detailFiltersBlock.show();this.$detailFiltersBlock.html(this._removeFormFromFiltersHTML(html));this._cacheFiltersPanelElements();this._createFiltersPanelWidgets();this._bindFiltersPanelEvents();this._readyFiltersPanel();this.updateFilteredAdsAmount();this.trigger(this._eventNames.update,this._generateDataForUpdateEvent());this.$constFiltersBlock.removeClass("search-block-special-off").addClass("search-block-special-on");this.spinner.hide(200);this.$detailFiltersBlock.animate({opacity:1},300);},this);this.trigger(this._eventNames.changeSearchArea);}}};FiltersManager.prototype._ready=function(){this._readySearchPanel();this._readyFiltersPanel();this.updateSelectedLocation();this.spinner.initialize();};FiltersManager.prototype._readySearchPanel=function(){this.changePath();this.locationManager.initialize();};FiltersManager.prototype._readyFiltersPanel=function(){ld(this.filters).forEach(function(filter){filter.initialize();this.updateSerializedData(filter.getSerializedData());if(filter.getId()==="abroad"&&filter.isChecked()){this.locationManager.setAbroad(true);this.$selectedLocation.text("За рубежом");}},this);this.amountSpinner.initialize();if(this.specialFiltersOpened){this.$toggleSpecialFilters.click();}if(!this.toggleSpecialWidth||this.toggleSpecialWidth<0){this.toggleSpecialWidth=this.$toggleSpecialFilters.width();}this.$toggleSpecialFilters.css("width",this.toggleSpecialWidth);};FiltersManager.prototype.isAllFiltersDefaultsValue=function(){var isDefault=this.locationManager.isDefaultValue();ld(this.filters).forEach(function(filter){if(!filter.isDefaultValue()){isDefault=false;return false;}},this);return isDefault;};FiltersManager.prototype.updateSelectedLocation=function(){var abroad=this.locationManager.isAbroad(),region=this.locationManager.getRegion(),locality=this.locationManager.getLocality();this.$selectedLocation.text(abroad?"За рубежом":locality.value?locality.text:region.value?region.text:"Все регионы");this.trigger(this._eventNames.closeLocationDialog,{data:{region:region.value?region.text:"",locality:locality.value?locality.text:""}});if(this.filters.cityDistrict){this.locationManager.setDistrict(this.filters.cityDistrict.getValue());}};FiltersManager.prototype._syncDistrictsFilter=function(){if(this.filters.cityDistrict){this.filters.cityDistrict.clear();ld(this.locationManager.getDistrictList()).forEach(function(district){this.filters.cityDistrict.addItem(district.value,district.text);},this);this.filters.cityDistrict.setValue(this.locationManager.getDistrict()||[]);this.filters.cityDistrict.show();global.ie!==8&&$('select[name="cityDistrict"]').multipleSelect({single:true});}};FiltersManager.prototype._generateDataForUpdateEvent=function(){var selectedFilters=[],region=this.locationManager.getRegion(),locality=this.locationManager.getLocality();if(locality.value){selectedFilters.push({id:"location",content:locality.text,isDefaultValue:false});}else{if(region.value){selectedFilters.push({id:"location",content:region.text,isDefaultValue:false});}}ld(this.getSelectedFilters()).forEach(function(filter){selectedFilters.push({id:filter.getId(),content:filter.getText(),isDefaultValue:false});},this);return{target:this,data:selectedFilters};};FiltersManager.prototype._deferExec=function(id,fn,e){clearTimeout(this.timeouts[id]);this.timeouts[id]=setTimeout(fn.bind(this,e),1000);};FiltersManager.prototype._closeSelectFilters=function(){if(global.ie===8){return;}ld(this.filters).forEach(function(filter){filter.getType()==="select"&&filter.close();});};FiltersManager.prototype.resetRegionValue=function(){this.locationManager.resetRegionValue();};FiltersManager.prototype.resetLocalityValue=function(){this.locationManager.resetLocalityValue();};FiltersManager.prototype.hasRubricFilters=function(){return this.isAdsRubric;};FiltersManager.prototype.getSelectedFilters=function(){var selectedFilters=[];ld(this.filters).forEach(function(filter){if(!filter.isDefaultValue()&&filter.$wrapper.is(":visible")){selectedFilters.push(filter);}});return selectedFilters;};FiltersManager.prototype.getSerializedData=function(){return this.serializedData;};FiltersManager.prototype.resetFilterValue=function(id){if(!this.filters[id]){this.$filtersForm.find('[name="'+id+'"]').val("");this.updateFilteredAdsAmount();return;}if(this.filters[id].isDefaultValue()){return;}this.filters[id].resetValue();};FiltersManager.prototype.getLocalityValue=function(){return this.locationManager.getLocality().value;};FiltersManager.prototype.resetAllFiltersValue=function(){this.locationManager.resetRegionValue();this.updateSelectedLocation();ld(this.filters).forEach(function(filter,name){if(filter.isDefaultValue()||name==="type"){return;}filter.resetValue();},this);this.selectedFiltersValues={};this.filters.type&&this.filters.type.resetValue();};FiltersManager.prototype.updateSerializedData=function(mapData){var rubricId=this.searchAreaManager.getRubric().id;if(ld.isArray(mapData)){ld(mapData).forEach(function(data){this.serializedData[data.key]=data.value;rubricId!==-1&&this.updateSavedRubricParams(rubricId,data.key,data.value);},this);}else{this.serializedData[mapData.key]=mapData.value;rubricId!==-1&&this.updateSavedRubricParams(rubricId,mapData.key,mapData.value);}};FiltersManager.prototype.updateSavedRubricParams=function(rubricId,key,value){this.savedRubricParams[rubricId]=this.savedRubricParams[rubricId]||{};this.savedRubricParams[rubricId][key]=value;};FiltersManager.prototype.updateSelectedFiltersValues=function(){ld(this.$filtersForm.serializeArray()).forEach(function(filter){this.selectedFiltersValues[filter.name]=filter.value;}.bind(this));this.selectedFiltersValues=ld.assign(this.selectedFiltersValues,this.ajaxParams);};FiltersManager.prototype.updateFilters=function(params,callback,context){$.post("/rubric-filters",params,callback.bind(context));};FiltersManager.prototype.reload=function(urlSuffix,urlParams,dontUpdateContent){this.searchAreaManager.reload(urlSuffix,urlParams,function(){this.changePath();this.$detailFiltersBlock.removeClass("hidden");var value=this.searchAreaManager.getValue();this.trigger(this._eventNames.changeSearchArea);this.$searchAreaValue.html(value.name);this.locationManager.reload(urlSuffix,urlParams,function(){this.updateSelectedLocation();$.post("/rubric-filters"+(urlSuffix||""),urlParams,function(html){this.$detailFiltersBlock.html(this._removeFormFromFiltersHTML(html));this._cacheFiltersPanelElements();this._createFiltersPanelWidgets();this._bindFiltersPanelEvents();this._readyFiltersPanel();this.updateFilteredAdsAmount();this.trigger(this._eventNames.update,ld.assign(this._generateDataForUpdateEvent(),{returnAction:true,urlSuffix:urlSuffix,dontUpdateContent:dontUpdateContent||false}));}.bind(this));}.bind(this));}.bind(this));};FiltersManager.prototype._removeFormFromFiltersHTML=function(html){return html.replace(/(<form([^>]+)>)/ig,"").replace(/(<\/form>)/ig,"");};FiltersManager.prototype.getSearchArea=function(){return this.searchAreaManager.getValue().action;};FiltersManager.prototype.getSection=function(){return this.searchAreaManager.getSection();};FiltersManager.prototype.updateFilteredAdsAmount=function(){this.$filteredAdsCounter.text("");this.$amountPhrase.hide();this.amountSpinner.show();this.lastUpdateFilteredAdsAmountRequest&&this.lastUpdateFilteredAdsAmountRequest.abort();this.trigger(this._eventNames.progressUpdateAmount);$.post("/api-web/ads-count",this.getFormData(),function(data){this.amountSpinner.hide();if(data.status===100){this.$amountPhrase.show();this.$filteredAdsCounter.text(data.response.count);}}.bind(this));};FiltersManager.prototype.getFormData=function(){var data=this.$filtersForm.serialize();if(this.ajaxParams){if(data){data+="&"+$.param(this.ajaxParams);}}data=data.replace(/selectItem[^&^=]*=[^&]*&/ig,"");data=data.replace(/[^&]*=&/ig,"");return data;};FiltersManager.prototype.getRubricId=function(){return this.$rubricParam.val();};FiltersManager.prototype.updateDependenciesFilters=function(filter){if(filter.getId()==="abroad"){this.locationManager.setAbroad(filter.isChecked());this.updateSelectedLocation();}ld(this.dependencies).forEach(function(dependence){if(filter.getId()===dependence.mainPropertyCode){if(dependence.propertyCode in this.filters){var dependFilter=this.filters[dependence.propertyCode];var hasMainPropertyValue=dependence.mainPropertyValues&&dependence.mainPropertyValues.length>0;var valueIsArray=Object.prototype.toString.call(filter.getValue())==="[object Array]";if(!(filter.isDefaultValue()||(valueIsArray&&filter.getValue().length>1)||hasMainPropertyValue)||(dependence.mainPropertyValues&&dependence.mainPropertyValues.indexOf(filter.getValue())>-1)){$.get("/get-limit-values",{property:dependFilter.getId(),stringLimitValue:filter.getTextValue(),rubric:this.rubricId,forFilters:true,withId:true},function(html){dependFilter.resetValues(html);if(dependence.mainPropertyValues){dependFilter.show();}else{dependFilter.enable();}}.bind(this));}else{if(dependence.mainPropertyValues){dependFilter.hide();}else{dependFilter.disable();}}this.trigger(this._eventNames.change,{target:this,dontTriggerEvent:true,data:{id:dependFilter.getId(),content:dependFilter.getText(),isDefaultValue:true}});}}}.bind(this));};FiltersManager.prototype.changePath=function(){this.$queryField.autocomplete({delay:0,minLength:1000,source:function(request,response){var previous_request=this.$queryField.data("jqXHR");previous_request&&previous_request.abort();this.$queryField.data("jqXHR",$.ajax({type:"POST",url:"/search-suggest",data:{q:this.$queryField.val().trim(),limit:"200"},dataType:"json",cache:false,success:function(data){response(data);}}));}.bind(this),change:function(event,ui){ui.item!==null&&this.$queryField.val(ui.item.value);}.bind(this),close:function(event,ui){this.$queryField.change();}.bind(this),select:function(event,ui){ui.item!==null&&this.$queryField.val(ui.item.value);}.bind(this)}).data("autocomplete")._renderItem=function(ul,item){return $("<li></li>").data("item.autocomplete",item).append("<a>"+item.value.replace(new RegExp(getRegExpString(this.term),"gi"),"<strong>$&</strong>")+"</a>").appendTo(ul);};var searchAreaVal=this.searchAreaManager.getValue().action;searchAreaVal.indexOf("search-tag")===-1?this.$queryField.autocomplete("option","minLength",1000).attr("autocomplete","on"):this.$queryField.autocomplete("option","minLength",1).attr("autocomplete","off");this.$filtersForm.attr("action",searchAreaVal);};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.widgets,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,widgets,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.layouts.LocationManager",LocationManager);Pattern.extend(LocationManager);function LocationManager(setup){setup=setup||{};this.ajaxParams=setup.ajaxParams;this.abroad=false;this.districtList=[];this.activeAjax={getLocationManagerContent:null,getLocalities:null,getDistricts:null};this._eventHandlers={};this._eventNames={apply:"apply",open:"open",close:"close"};}LocationManager.prototype._cacheElements=function(){this.$locationSelectArrow=$(".ads-filters-location.ms-choice div");this.$wrapper=$(".location-manager-wrapper");this.$locationContainer=this.$wrapper.find(".search-block-selects-wrapper");this.$regionContainer=this.$wrapper.find("div.location-manager-region-container");this.$localityContainer=this.$wrapper.find("div.location-manager-locality-container");this.$districtContainer=this.$wrapper.find("div.location-manager-district-container");this.$region=this.$regionContainer.find("select.location-manager-region");this.$locality=this.$localityContainer.find("select.location-manager-locality");this.$localityMS=this.$localityContainer.find("select.location-manager-locality + div.ms-parent");this.$district=this.$districtContainer.find("select.location-manager-district");this.$districtMS=this.$districtContainer.find("select.location-manager-district + div.ms-parent");this.$applyButton=this.$wrapper.find("input.location-manager-apply");this.$regionQuickLinks=this.$wrapper.find("a.location-manager-region-quicklink");this.$localityQuickLinks=this.$wrapper.find("a.location-manager-locality-quicklink");this.$countryQuickLinks=this.$wrapper.find("a.location-manager-country-quicklink");};LocationManager.prototype._createWidgets=function(){this.localitySpinner=new widgets.modules.Spinner({target:this.$localityContainer});this.districtSpinner=new widgets.modules.Spinner({target:this.$districtContainer});};LocationManager.prototype._bindEvents=function(){this.$wrapper.on("click",function(e){e.stopPropagation();});this.$region.on("change",this._events.changeRegion.bind(this));this.$locality.on("change",this._events.changeLocality.bind(this));this.$applyButton.on("click",this._events.clickApplyButton.bind(this));this.$regionQuickLinks.on("click",this._events.clickRegionQuickLink.bind(this));this.$localityQuickLinks.on("click",this._events.clickLocalityQuickLink.bind(this));this.$countryQuickLinks.on("click",this._events.clickCountryQuickLink.bind(this));};LocationManager.prototype._events={changeRegion:function(){this.abroad=false;this.updateLocality();},changeLocality:function(){this.abroad=false;this.updateDistrict();},clickApplyButton:function(){this.close();this.trigger(this._eventNames.apply,{target:this,data:{region:this.getRegion(),locality:this.getLocality(),district:this.getDistrict()}});},clickCountryQuickLink:function(e){this.abroad=true;this.$region.val("");if(ie!==8){this.$region.multipleSelect("refresh");}this.close();this.updateLocality(function(){this.trigger(this._eventNames.apply,{target:this,data:{region:this.getRegion(),locality:this.getLocality(),district:this.getDistrict(),abroad:e.target.getAttribute("data-abroad")}});},this);},clickRegionQuickLink:function(e){this.abroad=false;this.$region.val(e.target.getAttribute("data-region-value"));if(ie!==8){this.$region.multipleSelect("refresh");}this.close();this.updateLocality(function(){this.trigger(this._eventNames.apply,{target:this,data:{region:this.getRegion(),locality:this.getLocality(),district:this.getDistrict()}});},this);},clickLocalityQuickLink:function(e){this.abroad=false;this.$region.val(e.target.getAttribute("data-region-value"));if(ie!==8){this.$region.multipleSelect("refresh");}this.close();this.updateLocality(function(){this.$locality.val(e.target.getAttribute("data-locality-value"));if(ie!==8){this.$locality.multipleSelect("refresh");}this.updateDistrict(function(){if(ie!==8){this.$district.multipleSelect("refresh");}this.trigger(this._eventNames.apply,{target:this,data:{region:this.getRegion(),locality:this.getLocality(),district:this.getDistrict()}});},this);},this);},openDialog:function(){this.open();},closeDialog:function(){this.close();}};LocationManager.prototype._service={getLocationManagerContent:function(urlSuffix,urlParams,callback,context){this.activeAjax.getLocationManagerContent&&this.activeAjax.getLocationManagerContent.abort();this.activeAjax.getLocationManagerContent=$.post("/get-location-manager-content"+(urlSuffix||""),urlParams||"",callback.bind(context)).error(callback.bind(context));},getLocalities:function(regionName,callback,context){this.activeAjax.getLocalities&&this.activeAjax.getLocalities.abort();this.activeAjax.getLocalities=$.post("/api-web/get-limit-values",ld.assign(this.ajaxParams,{property:"locality",stringLimitValue:regionName,forFilters:true}),callback.bind(context),"json").error(callback.bind(context));},getDistricts:function(regionName,localityName,callback,context){this.activeAjax.getDistrict&&this.activeAjax.getDistrict.abort();this.activeAjax.getDistrict=$.post("/api-web/get-limit-values",ld.assign(this.ajaxParams,{property:"cityDistrict",forFilters:true,stringLimitValue:localityName,regionName:regionName}),callback.bind(context),"json").error(callback.bind(context));}};LocationManager.prototype._ready=function(){this.localitySpinner.initialize();this.districtSpinner.initialize();this.$wrapper.length&&!this.$region.find("option").length&&this._service.getLocationManagerContent.call(this,"","",function(html){this.$wrapper.html(html);this.initialize();},this);if(!this.getRegion().value){this.$localityMS.hide();}if(!this.getLocality().value){this.$districtMS.hide();}else{ld(this.$district.find("option")).forEach(function(obj){if(obj.value){this.districtList.push({value:obj.value,text:obj.text});}}.bind(this));}};LocationManager.prototype.reload=function(urlSuffix,urlParams,successCallback){this._service.getLocationManagerContent.call(this,urlSuffix,urlParams,function(html){this.$wrapper.html(html);this.initialize();if(successCallback){successCallback();}}.bind(this));};LocationManager.prototype.updateLocality=function(callback,context){this.districtList=[];this.$localityMS.hide();this.$locality.find("option:not(:first)").remove();this.$districtMS.hide();this.$district.find("option:not(:first)").remove();if(this.$region.find(":selected").is(":first-child")){return;}this.localitySpinner.show();this._service.getLocalities.call(this,this.$region.find(":selected").text(),function(data){if(data&&data.status===100&&data.response&&data.response.values){try{ld(data.response.values).forEach(function(locality){this.$locality.append(ld.template('<option value="${value}">${text}</option>',{value:locality.id,text:locality.value}));},this);}catch(exception){utils.Common.logEvent({packageName:"ru.cmlt.widgets.layouts.LocationManager",functionName:"_events.changeRegion",exception:exception});}this.localitySpinner.hide(300,function(){if(this.getRegion().value){if(ie!==8){this.$locality.multipleSelect("refresh");this.$localityMS.show();}}ld.isFunction(callback)&&callback.call(context);}.bind(this));}else{this.localitySpinner.hide(300,function(){ld.isFunction(callback)&&callback.call(context);});}},this);};LocationManager.prototype.updateDistrict=function(callback,context){this.districtList=[];this.$districtMS.hide();this.$district.find("option:not(:first)").remove();if(this.$locality.find(":selected").is(":first-child")){return;}this.districtSpinner.show();this._service.getDistricts.call(this,this.$region.find(":selected").text(),this.$locality.val(),function(data){if(data&&data.status===100&&data.response&&data.response.values){ld(data.response.values).forEach(function(district){this.districtList.push({value:district.id,text:district.value});this.$district.append(ld.template('<option value="${value}">${text}</option>',{value:district.id,text:district.value}));},this);this.districtSpinner.hide(300,function(){if(ie!==8){if(this.getLocality().value){this.$district.multipleSelect("refresh");this.$districtMS.show();}}ld.isFunction(callback)&&callback.call(context);}.bind(this));}else{this.districtSpinner.hide(300,function(){ld.isFunction(callback)&&callback.call(context);}.bind(this));}},this);};LocationManager.prototype.toggle=function(){this.$wrapper.is(":hidden")?this.open():this.close();};LocationManager.prototype.open=function(){this.$locationSelectArrow.addClass("open");this.$wrapper.fadeIn(300);this.trigger(this._eventNames.open);};LocationManager.prototype.close=function(){this.$locationSelectArrow.removeClass("open");this.$wrapper.fadeOut(200);this.trigger(this._eventNames.close);};LocationManager.prototype.getSerializedData=function(){return[{key:this.$region.attr("name"),value:this.$region.val()},{key:this.$locality.attr("name"),value:this.$locality.val()}];};LocationManager.prototype.isAbroad=function(){return this.abroad;};LocationManager.prototype.setAbroad=function(abroad){this.abroad=abroad;this.$region.val("");if(ie!==8){this.$region.multipleSelect("refresh");}this.updateLocality(this);};LocationManager.prototype.getRegion=function(){var $option=this.$region.find("option:selected");return{value:$option.val(),text:$option.text().trim()};};LocationManager.prototype.getLocality=function(){var $option=this.$locality.find("option:selected");return{value:$option.val(),text:$option.text().trim()};};LocationManager.prototype.getDistrict=function(){return this.$district.val();};LocationManager.prototype.setDistrict=function(value){if(ie!==8){this.$district.multipleSelect("setSelects",value).multipleSelect("refresh");}};LocationManager.prototype.getDistrictList=function(){return this.districtList;};LocationManager.prototype.setRubric=function(rubric){this.ajaxParams.rubric=rubric;};LocationManager.prototype.resetRegionValue=function(){this.$region.val(this.$region.find("option").first().val());if(ie!==8){this.$region.multipleSelect("refresh");}this.updateLocality();};LocationManager.prototype.resetLocalityValue=function(){this.$locality.val(this.$locality.find("option").first().val());if(ie!==8){this.$locality.multipleSelect("refresh");}this.updateDistrict();};LocationManager.prototype.hasDistricts=function(){return this.$district.find("option").length>1;};LocationManager.prototype.isDefaultValue=function(){return !this.$region.find(":selected").length||this.$region.find(":selected").is(":first-child");};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.widgets,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,widgets,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.layouts.SearchAreaManager",SearchAreaManager);Pattern.extend(SearchAreaManager);function SearchAreaManager(setup){setup=setup||{};this.rubric={id:setup.rubricId||-1,name:setup.rubricName||""};this.selectedValue={action:setup.selectedValue||"",name:setup.selectedValueName||""};this._eventHandlers={};this._eventNames={apply:"apply",update:"update",open:"open",close:"close"};this.activeAjax={getSearchAreaManagerContent:null};}SearchAreaManager.prototype._cacheElements=function(){this.$wrapper=$(".sam-wrapper");this.$selects=[];ld(this.$wrapper.find("select")).forEach(function(select){var level=parseInt(select.getAttribute("data-rubric-level"))-1;this.$selects[level]=$(select);}.bind(this));this.$rubricSelectArrow=$(".sam-toggle.ms-parent div");this.$searchAreaManagerApply=this.$wrapper.find(".sam-apply");this.$quickLinks=this.$wrapper.find(".sam-quicklink");};SearchAreaManager.prototype._createWidgets=function(){this.rubricSpinner=new widgets.modules.Spinner({target:this.$wrapper});};SearchAreaManager.prototype._bindEvents=function(){this.$wrapper.on("click",function(e){e.stopPropagation();});ld(this.$selects).forEach(function(select){select.on("change",this._events.rubricChanged.bind(this));}.bind(this));this.$searchAreaManagerApply.on("click",this._events.applyButtonClicked.bind(this));this.$quickLinks.on("click",this._events.quickLinkClicked.bind(this));};SearchAreaManager.prototype._events={rubricChanged:function(e){var level=parseInt(e.target.getAttribute("data-rubric-level"));var rubricId=$(e.target).find(":selected").val();var $select=this.$selects[level];if($select){if(!rubricId){$select.html("").hide();}else{this._service.getRubrics(rubricId,function(rubrics,context){$select.html("");if(rubrics&&rubrics.length>0){$select.append('<option value="">Все объявления рубрики</option>');ld(rubrics).forEach(function(rubric){if(rubric){$select.append(ld.template('<option value="${value}">${text}</option>',{value:rubric.id,text:rubric.name}));}});$select.show();}else{$select.hide();}ld(this.$selects).forEach(function($select){if($select.attr("data-rubric-level")>level+1){$select.html("");$select.hide();}}.bind(context));}.bind(this),this);}}},applyButtonClicked:function(){ld(this.$selects).forEach(function($select){var selected=$select.find(":selected");if(selected&&selected.val()){this.rubric={id:selected.val(),name:selected.text()};}}.bind(this));if(this.selectedValue.action!=="/org/ads"){this.selectedValue.action="/ads";}this.selectedValue.name=this.rubric.name;this.trigger(this._eventNames.apply);this.close();},quickLinkClicked:function(e){var quicklink=$(e.target);this.rubric={};this.selectedValue={action:quicklink.attr("data-value"),name:quicklink.text()};this.trigger(this._eventNames.apply);ld(this.$selects).forEachRight(function($select){if($select.attr("data-rubric-level")!=="1"){$select.hide();$select.html("");}else{$select.val("");}}.bind(this));this.close();}};SearchAreaManager.prototype._service={getRubrics:function(parentRubricId,callback,context){$.get("/api-web/paladin/subrubrics?parentRubric="+parentRubricId+"&apiVersion=2.0.0",function(data){if(data){if(data.status===100){callback(data.response.rubrics,context);}else{}}},"json");},getSearchAreaManagerContent:function(urlSuffix,urlParams,callback,context){this.activeAjax.getSearchAreaManagerContent&&this.activeAjax.getSearchAreaManagerContent.abort();this.activeAjax.getSearchAreaManagerContent=$.post("/search-area-manager-content"+(urlSuffix||""),urlParams||"",callback.bind(context)).error(callback.bind(context));}};SearchAreaManager.prototype._ready=function(){};SearchAreaManager.prototype.toggle=function(){this.$wrapper.is(":hidden")?this.open():this.close();};SearchAreaManager.prototype.open=function(){this.$rubricSelectArrow.addClass("open");this.$wrapper.fadeIn(300);this.trigger(this._eventNames.open);};SearchAreaManager.prototype.close=function(){this.$rubricSelectArrow.removeClass("open");this.$wrapper.fadeOut(200);this.trigger(this._eventNames.close);};SearchAreaManager.prototype.getSerializedData=function(){return this.rubric+this.selectedValue;};SearchAreaManager.prototype.getRubric=function(){return this.rubric;};SearchAreaManager.prototype.getSection=function(){var sectionId;ld(this.$selects).forEach(function($select){if($select.attr("data-rubric-level")==="1"){sectionId=$select.val();}});return sectionId?sectionId:-1;};SearchAreaManager.prototype.getValue=function(){return this.selectedValue;};SearchAreaManager.prototype.isDefaultValue=function(){return this.selectedValue.action==="/search";};SearchAreaManager.prototype.reload=function(urlSuffix,urlParams,successCallback){this._service.getSearchAreaManagerContent.call(this,urlSuffix,urlParams,function(html){this.$wrapper.html(html);this.initialize();this.rubric={};ld(this.$selects).forEach(function($select){var selected=$select.find(":selected");if(selected&&selected.val()){this.rubric={id:selected.val(),name:selected.text()};}}.bind(this));if(this.selectedValue.action!=="/org/ads"){this.selectedValue.action="/ads";}this.selectedValue.name=this.rubric.name||this.$quickLinks.filter('[data-value="/ads"]').text();successCallback();}.bind(this));};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.widgets,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.layouts.SavedFiltersManager",SavedFiltersManager);Pattern.extend(SavedFiltersManager);function SavedFiltersManager(setup){setup=setup||{};this.actions={saveFilters:{url:"/api-web/profile/save-filters",params:{apiVersion:"2.0.0",rubricId:setup.ajaxParams?setup.ajaxParams.rubricId:"",device:setup.ajaxParams?setup.ajaxParams.device:"",name:"",urlParams:""},dataType:"json"},removeFilters:{url:"/api-web/profile/remove-saved-filters",params:{apiVersion:"2.0.0",oldSaveFiltersId:""},dataType:"json"},renameFilters:{url:"/api-web/profile/rename-saved-filters",params:{apiVersion:"2.0.0",name:"",oldSaveFiltersId:""},dataType:"json"}};this.filtersId=setup.id;this.filtersDefaultValue=setup.defaultValue||"";this.filtersValue="";this.query=window.location.search;this._eventHandlers={};this._eventNames={create:"create",remove:"remove",rename:"rename",change:"change",ready:"ready"};}SavedFiltersManager.prototype._cacheElements=function(){this.$outside=$(global.document);this.$filtersName=$("#saved-filters-name");this.$filtersSavedName=$("#saved-filters-name span");this.$renameBlock=$("#saved-filters-rename-block");this.$saveButton=$("#saved-filters-block-button-save");this.$cancelButton=$("#saved-filters-block-button-cancel");this.$editButton=$(".saved-filters-edit-button");this.$renameField=$("#saved-filters-rename-input");this.$removeButton=$("#saved-filters-block-remove");this.$closeButton=$(".saved-filters-close-button");};SavedFiltersManager.prototype._bindEvents=function(){this.$outside.on("click",this._events.clickOutside.bind(this));this.$filtersName.on("click",this._events.clickFiltersName.bind(this));this.$renameBlock.on("keydown click",this._events.changeRenameBlock.bind(this));this.$saveButton.on("click",this._events.clickSaveButton.bind(this));this.$cancelButton.on("click",this._events.clickCancelButton.bind(this));this.$closeButton.on("click",this._events.clickCloseButton.bind(this));this.$renameField.on("keyup",this._events.changeRenameField.bind(this));this.$removeButton.on("click",this._events.clickRemoveButton.bind(this));};SavedFiltersManager.prototype._events={clickOutside:function(e){this.hideEditDialog();},clickFiltersName:function(e){e.stopPropagation();this.showEditDialog();},changeRenameBlock:function(e){if(e.type==="click"){return e.stopPropagation();}switch(e.keyCode){case 27:this.hideEditDialog();break;case 13:this.saveFilters();this.hideEditDialog();break;}},clickSaveButton:function(e){this.saveFilters();this.hideEditDialog();},clickCancelButton:function(e){this.hideEditDialog();},clickCloseButton:function(e){this.hideEditDialog();},changeRenameField:function(e){this._checkSavedFiltersNameValid(this.$renameField.get(0));},clickRemoveButton:function(e){this.removeFilters();},show:function(){this.checkTextOverflowFiltersName();}};SavedFiltersManager.prototype.checkTextOverflowFiltersName=function(){this._checkTextOverflowContainer(this.$filtersName);};SavedFiltersManager.prototype._ready=function(){this._checkSavedFiltersNameValid(this.$renameField.get(0));this._updateCurrentFiltersData(this.filtersId,this.$renameField.val());if(global.ontouchstart||global.onmsgesturechange){this.$editButton.show();}this.trigger(this._eventNames.ready);};SavedFiltersManager.prototype._responseHandler=function(data,successCallback,notLoggedUrl){var status=data.status,response=data.response,messagesString="",handlerData;if(response){ld(response.messages).forEach(function(value){messagesString+=value.message+"\n";});}switch(status){case 100:successCallback();handlerData={message:messagesString,status:"SUCCESS"};break;case 102:handlerData={message:messagesString,status:"NOT_LOGGED",url:notLoggedUrl};break;default:if(messagesString===""){messagesString="Не удалось выполнить операцию";}handlerData={message:messagesString,status:"OTHER_ERROR"};break;}this.trigger(this._eventNames.change,handlerData);};SavedFiltersManager.prototype._getSavedFiltersName=function(){return utils.Common.htmlDecode(this.$renameField.val().trim());};SavedFiltersManager.prototype._updateCurrentFiltersData=function(id,value){this.filtersId=id;this.filtersValue=value;};SavedFiltersManager.prototype._checkTextOverflowContainer=function(o){var $gradient=$(ld.template(".${ id }-gradient",{id:o.attr("id")}));o.prop("scrollWidth")>o.outerWidth()?$gradient.show():$gradient.hide();};SavedFiltersManager.prototype._checkSavedFiltersNameValid=function(field){utils.Common.checkSpecialsSymbols(field);utils.Common.validateLength(field,field.getAttribute("maxlength"),this.$saveButton.attr("id"));};SavedFiltersManager.prototype.updateState=function(){$.get("/api-web/profile/check-saved-filters-exists"+this.query,function(data){if(100==data.status&&data.response&&data.response.savedFiltersGroup){this.$filtersName.removeClass("button-custom-with-border").addClass("saved-filters-saved-name");this.$filtersSavedName.text(data.response.savedFiltersGroup.name).addClass("dotted-link");this.filtersId=data.response.savedFiltersGroup.id;}else{this.$filtersName.removeClass("saved-filters-saved-name").addClass("button-custom-with-border");this.$filtersSavedName.text("Сохранить поиск").removeClass("dotted-link");this.filtersId=-1;}this._checkTextOverflowContainer(this.$filtersName);}.bind(this));};SavedFiltersManager.prototype.createFilters=function(){var query=window.location.pathname+this.query,name=this._getSavedFiltersName(),params=this.actions.saveFilters.params,loginURL=ld.template("/profile/save-filters?name=${ name }&urlParams=${ urlParams }&device=${ device }"+"&rubricId=${ rubricId }&returnURL=${ returnURL }",{name:name,urlParams:encodeURIComponent(query),device:params.device,rubricId:params.rubricId,returnURL:encodeURIComponent(query)});$.post(this.actions.saveFilters.url,ld.assign(params,{name:name,urlParams:query}),function(data){this._responseHandler(data,function(){this.$cancelButton.hide();this.$removeButton.show();this.$filtersName.removeClass("button-custom-with-border").addClass("saved-filters-saved-name");this.$filtersSavedName.text(name).addClass("dotted-link");this._checkTextOverflowContainer(this.$filtersName);this._updateCurrentFiltersData(data.response.id,name);this.trigger(this._eventNames.create,{id:data.response.id,name:name});}.bind(this),loginURL);}.bind(this),this.actions.saveFilters.dataType);};SavedFiltersManager.prototype.renameFilters=function(){var name=this._getSavedFiltersName(),loginURL=ld.template("/profile/rename-saved-filters?id=${ id }&name=${ name }&returnURL=${ returnURL }",{id:this.filtersId,name:name,returnURL:encodeURIComponent(document.location)});$.post(this.actions.renameFilters.url,ld.assign(this.actions.renameFilters.params,{name:name,oldSaveFiltersId:this.filtersId}),function(data){this._responseHandler(data,function(){this.$filtersName.removeClass("button-custom-with-border").addClass("saved-filters-saved-name");this.$filtersSavedName.text(name).addClass("dotted-link");this._checkTextOverflowContainer(this.$filtersName);this._updateCurrentFiltersData(this.filtersId,name);this.trigger(this._eventNames.rename,{id:this.filtersId,name:name});}.bind(this),loginURL);}.bind(this),this.actions.renameFilters.dataType);};SavedFiltersManager.prototype.removeFilters=function(){var loginURL=ld.template("/profile/remove-saved-filters?id=${ id }&returnURL=${ returnURL }",{id:this.filtersId,returnURL:encodeURIComponent(document.location)});$.post(this.actions.removeFilters.url,ld.assign(this.actions.removeFilters.params,{oldSaveFiltersId:this.filtersId}),function(data){this._responseHandler(data,function(){this.$renameField.val(this.filtersDefaultValue);this.$removeButton.hide();this.$cancelButton.show();this.$filtersName.removeClass("saved-filters-saved-name").addClass("button-custom-with-border");this.$filtersSavedName.text("Сохранить поиск").removeClass("dotted-link");this._checkTextOverflowContainer(this.$filtersName);this._updateCurrentFiltersData(null,"");this.trigger(this._eventNames.remove);}.bind(this),loginURL);}.bind(this),this.actions.removeFilters.dataType);this.hideEditDialog();};SavedFiltersManager.prototype.saveFilters=function(){if(!this.filtersId||this.filtersId<0){this.createFilters();}else{if(this._getSavedFiltersName()!==this.filtersValue.trim()){this.renameFilters();}}};SavedFiltersManager.prototype.showEditDialog=function(){this.$renameBlock.fadeIn(300);this.$renameField.focus()[0].setSelectionRange(0,this.$renameField.val().length);};SavedFiltersManager.prototype.hideEditDialog=function(){this.$renameBlock.fadeOut(200);};SavedFiltersManager.prototype.setEditFieldText=function(value){this.$renameField.val(this.filtersValue=value);};SavedFiltersManager.prototype.setQuery=function(params){this.query="?"+params;};SavedFiltersManager.prototype.setRubricId=function(rubricId){this.actions.saveFilters.params.rubricId=rubricId;};SavedFiltersManager.prototype.setFiltersId=function(filtersId){this.filtersId=filtersId;};SavedFiltersManager.prototype.setEditDialogPosition=function(top,right,bottom,left){this.$renameBlock.css({top:top,right:right,bottom:bottom,left:left});};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.layouts.TyreCalculator",TyreCalculator);Pattern.extend(TyreCalculator);function TyreCalculator(elements){this.elements={diameterSelect:elements.diameterSelect,sideViewSelect:elements.sideViewSelect,widthSelect:elements.widthSelect};this.sideViewDefault=80;this._eventHandlers={};this._eventNames={calculate:"calculate",close:"close",open:"open"};}TyreCalculator.prototype._cacheElements=function(){this.$tyreContainer=$("div.tyre-calculator-container");this.$tyreHeightField=$("#tyre-calculator-height");this.$tyreWidthField=$("#tyre-calculator-width");this.$tyreDiameterSelect=$("#tyre-calculator-diameter");this.$tyreCloseButton=$("div.tyre-calculator-close");this.$tyreCalculateButton=$("#tyre-calculator-calc");this.$resultDiameterSelect=$(this.elements.diameterSelect);this.$resultSideViewSelect=$(this.elements.sideViewSelect);this.$resultWidthSelect=$(this.elements.widthSelect);};TyreCalculator.prototype._bindEvents=function(){this.$tyreCalculateButton.on("click",this._events.clickTyreCalculateButton.bind(this));this.$tyreCloseButton.on("click",this._events.clickTyreCloseButton.bind(this));};TyreCalculator.prototype._events={clickTyreCalculateButton:function(e){this.calculate();},clickTyreCloseButton:function(e){this.close();}};TyreCalculator.prototype._ready=function(){this._fillDiameterSelect();};TyreCalculator.prototype._fillDiameterSelect=function(){var htmlOptions="";ld(this._parseResultDiameterSelect()).forEach(function(value){htmlOptions+=ld.template('<option value="${value}">${value}</option>',{value:value});});this.$tyreDiameterSelect.append(htmlOptions);if(ie!==8){this.$tyreDiameterSelect.multipleSelect({single:true,width:93});}};TyreCalculator.prototype._parseResultDiameterSelect=function(){var diameters=[];this.$resultDiameterSelect.find("option").each(function(index,option){diameters.push(option.text);});return diameters;};TyreCalculator.prototype._setResultExactValue=function($select,text){var found=false;$select.find("option").each(function(index,option){if(+option.text===text){$select.val(option.value);return found=true;}});return found;};TyreCalculator.prototype._setResultNearValue=function($select,text){if(!this._isNumber(text)){return $select.val(null);}if(this._setResultExactValue($select,text)){return;}var selectValues=[];$select.find("option").each(function(index,option){if(!this._isNumber(option.text)){return;}selectValues.push(option.text);}.bind(this));if(!selectValues.length){return $select.val(null);}var near=0;for(var i=0,len=selectValues.length;i<len;i++){if(i!==len-1&&Math.abs(selectValues[i]-text)>Math.abs(selectValues[i+1]-text)){near=i+1;}}return this._setResultExactValue($select,selectValues[near]);};TyreCalculator.prototype._isNumber=function(n){return n?!isNaN(parseFloat(n.toString().replace(/\s+/g,"").replace(",",".")))&&isFinite(parseFloat(n.toString().replace(/\s+/g,"").replace(",","."))):false;};TyreCalculator.prototype.open=function(){this.$tyreContainer.show();this.trigger(this._eventNames.open);};TyreCalculator.prototype.close=function(){this.$tyreContainer.hide();this.trigger(this._eventNames.close);};TyreCalculator.prototype.calculate=function(){var tyreWidth=+this.$tyreWidthField.val().trim().replace(",","."),tyreDiameter=+this.$tyreDiameterSelect.val();if(!tyreWidth||!tyreDiameter){return this.trigger(this._eventNames.calculate,null);}var tyreHeight=+this.$tyreHeightField.val().trim().replace(",","."),result={diameter:tyreDiameter,sideView:tyreHeight?Math.round((tyreHeight-tyreDiameter)*100/2/tyreWidth/5)*5:this.sideViewDefault,width:Math.round(tyreWidth*25.4/5)*5};this._setResultNearValue(this.$resultDiameterSelect,result.diameter);this._setResultNearValue(this.$resultSideViewSelect,result.sideView);this._setResultNearValue(this.$resultWidthSelect,result.width);this.trigger(this._eventNames.calculate,result);};TyreCalculator.prototype.getContainer=function(){return this.$tyreContainer;};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,widgets,utils,$,ld){utils.Package.declare("ru.cmlt.widgets.layouts.SearchBlock",SearchBlock);Pattern.extend(SearchBlock);function SearchBlock(setup){setup=setup||{};this.ajaxParams=setup.ajaxParams||{};this.savedFiltersManagerSetup=setup.savedFiltersManager;this.filtersManagerSetup=setup.filtersManager;this.tagsPanelSetup=setup.tagsPanel;this.rubricsStyles=setup.rubricsStyles||{};this.searchAreaManagerSetup=setup.searchAreaManager||{};this._eventHandlers={};this._eventNames={change:"change"};}SearchBlock.prototype._cacheElements=function(){this.$wrapper=$("div.search-block-wrapper");this.$sectionMainPageLink=this.$wrapper.find(".search-block-part-link");this.$tagsPanelWrapper=this.$wrapper.find("div.search-block-tags-panel");this.$tagsPanel=this.$wrapper.find("div[data-tags-panel]");};SearchBlock.prototype._createWidgets=function(){this.dialog=new widgets.modules.Dialog();this.tagsPanelSetup.wrapper=this.$tagsPanel;this.tagsPanel=new widgets.modules.TagsPanel(this.tagsPanelSetup);this.savedFiltersManager=new widgets.layouts.SavedFiltersManager(this.savedFiltersManagerSetup);this.searchAreaManager=new widgets.layouts.SearchAreaManager(this.searchAreaManagerSetup);this.filtersManagerSetup.searchAreaManager=this.searchAreaManager;this.filtersManager=new widgets.layouts.FiltersManager(this.filtersManagerSetup);};SearchBlock.prototype._bindEvents=function(){this.filtersManager.on("hide",this._events.hideFiltersManager,this);this.filtersManager.on("update",this._events.updateFiltersManager,this);this.filtersManager.on("change",this._events.changeFiltersManager,this);this.filtersManager.on("closeLocationDialog",this._events.closeLocationDialog,this);this.filtersManager.on("progressUpdateAmount",this._events.progressUpdateAdsAmount,this);this.filtersManager.on("changeSearchArea",this._events.searchAreaChanged,this);this.tagsPanel.on("add",this._events.addTag,this);this.tagsPanel.on("remove",this._events.removeTag,this);this.tagsPanel.on("clear",this._events.clearTags,this);this.tagsPanel.on("show",this._events.showSavedFiltersManager,this);this.savedFiltersManager.on("change",this._events.changeSavedFilters,this);};SearchBlock.prototype._events={showSavedFiltersManager:function(){this.savedFiltersManager.checkTextOverflowFiltersName();},hideFiltersManager:function(){this.tagsPanel.clear();},updateFiltersManager:function(e){this.onChange(e);this.tagsPanel.reset();ld(e.data).forEach(function(data){data.isDefaultValue?this.tagsPanel.remove(data.id):this.tagsPanel.add(data.id,data.content,false);},this);if(e.data.length===0){this.$tagsPanelWrapper.slideUp(200);}},changeFiltersManager:function(e){e.data.isDefaultValue?this.tagsPanel.remove(e.data.id):this.tagsPanel.add(e.data.id,e.data.content,true);if(!e.dontTriggerEvent&&this.filtersManager.getSearchArea()==="/ads"||this.filtersManager.getSearchArea()==="/org/ads"){this.onChange();}else{this.$tagsPanelWrapper.slideUp(200);}},closeLocationDialog:function(e){if(e.data.locality){this.tagsPanel.add("location",e.data.locality,true);}else{if(e.data.region){this.tagsPanel.add("location",e.data.region,true);}else{this.tagsPanel.remove("location");}}if(e.data.changed){this.onChange();}},progressUpdateAdsAmount:function(){this.updateSavedFiltersState();},addTag:function(){if(this.$tagsPanelWrapper.is(":hidden")&&(this.filtersManager.getSearchArea()==="/ads"||this.filtersManager.getSearchArea()==="/org/ads")){this.$tagsPanelWrapper.slideDown(200);}},removeTag:function(e){switch(e.data.id){case"location":this.filtersManager.resetRegionValue();this.tagsPanel.remove("cityDistrict");this.filtersManager.updateSelectedLocation();this.filtersManager.updateFilteredAdsAmount();break;default:this.filtersManager.resetFilterValue(e.data.id);break;}if(this.tagsPanel.isEmpty()){this.$tagsPanelWrapper.slideUp(200);}},clearTags:function(){this.filtersManager.resetAllFiltersValue();this.$tagsPanelWrapper.slideUp(200);},changeSavedFilters:function(data){switch(data.status){case"SUCCESS":if(data.message){this.dialog.setContent("correctBlock",data.message);this.dialog.open();}break;case"NOT_LOGGED":document.location.href=data.url;break;default:this.dialog.setContent("errorBlock",data.message);this.dialog.open();break;}},searchAreaChanged:function(){if(this.filtersManager.getSearchArea()==="/ads"||this.filtersManager.getSearchArea()==="/org/ads"){var section=this.filtersManager.getSection();var style=this.rubricsStyles[section];if(!style){style=this.rubricsStyles["default"];}if(style){ld(this.rubricsStyles).forEach(function(rubricStyle){this.$wrapper.removeClass(rubricStyle.styleClass);}.bind(this));this.$wrapper.addClass(style.styleClass);this.$sectionMainPageLink.text(style.linkText).attr("href",style.linkPath);}}}};SearchBlock.prototype._ready=function(){this.dialog.initialize();this.searchAreaManager.initialize();this.tagsPanel.initialize();this.filtersManager.initialize();this.savedFiltersManager.initialize();var searchArea=this.filtersManager.getSearchArea();if(searchArea==="/ads"||searchArea==="/org/ads"){var selectedFilters=this.filtersManager.getSelectedFilters();if(selectedFilters&&selectedFilters.length>0){this.$tagsPanelWrapper.show();ld(this.filtersManager.getSelectedFilters()).forEach(function(filter){this.tagsPanel.add(filter.getId(),filter.getText(),false);},this);}}this.savedFiltersManager.setEditDialogPosition(-24,"auto","auto","auto");};SearchBlock.prototype.updateSavedFiltersState=function(){this.savedFiltersManager.setQuery(this.filtersManager.getFormData());this.savedFiltersManager.setRubricId(this.filtersManager.getRubricId());this.savedFiltersManager.updateState();};SearchBlock.prototype.onChange=function(e){if(e&&e.dontUpdateContent){return;}this.trigger(this._eventNames.change,{data:this.filtersManager.getFormData(),returnAction:e&&e.returnAction,urlSuffix:(e&&e.urlSuffix)||""});};SearchBlock.prototype.reload=function(urlSuffix,urlParams,dontUpdateContent){this.filtersManager.reload(urlSuffix,urlParams,dontUpdateContent,this.filtersManager);};})(window,window.ru.cmlt.patterns.Widget,window.ru.cmlt.widgets,window.ru.cmlt.utils,window.jQuery,window._);(function(global,Pattern,widgets,utils,$,ld){utils.Package.declare("ru.cmlt.pages.Ans",Ans);Pattern.extend(Ans);function Ans(pageScope){this.searchBlockSetup=pageScope.searchBlock;this.contentPlaceholderSelector=pageScope.contentPlaceholderSelector;this.dinamycAdsLoading=pageScope.dinamycAdsLoading;this.adsRequest=null;this.historyAvailable=!!window.history.pushState;}Ans.prototype._cacheElements=function(){if(this.contentPlaceholderSelector){this.$contentPlaceholder=$(this.contentPlaceholderSelector);this.$contentPlaceholderLoader=this.$contentPlaceholder.find(".content-placeholder-loader");this.$blockOnPlaceholder=$(".search-block-on-placeholder");this.$buttonsOnPlaceholder=this.$blockOnPlaceholder.find(".search-block-on-placeholder-buttons");}};Ans.prototype._createWidgets=function(){this.searchBlock=new widgets.layouts.SearchBlock(this.searchBlockSetup);};Ans.prototype._bindEvents=function(){this.searchBlock.on("change",this._events.searchBlockChanged,this);if(this.historyAvailable&&this.dinamycAdsLoading){this._initContentBlock();$(document).on("click","a.ajax",function(e){var url=e.target.href?e.target.href:e.target.parentElement.href;var urlSuffix=url.substr(url.indexOf("/ads")+4);var paramsIndex=urlSuffix.indexOf("?");if(paramsIndex!==-1){urlSuffix=urlSuffix.substr(0,paramsIndex);}this.searchBlock.reload(urlSuffix,null,true);this.updateAdsContent(url,null,true);return false;}.bind(this));}};Ans.prototype._initContentBlock=function(){$(".view-types-switch a").removeAttr("onclick");$('select[name="order"]').removeAttr("onchange").on("change",function(e){var form=e.target.form;this.updateAdsContent(form.action,$(form).serialize(),true);return false;}.bind(this));$(".page-navigator-bottom a").on("click",function(){$("body,html").animate({scrollTop:0},800);});};Ans.prototype._events={searchBlockChanged:function(e){if(this.historyAvailable&&this.dinamycAdsLoading){this.updateAdsContent("/ads"+(e.urlSuffix||""),e.data,!e.returnAction);}else{if(this.contentPlaceholderSelector){if(this.searchBlock.filtersManager.getSearchArea()!=="/ads"&&this.searchBlock.filtersManager.getSearchArea()!=="/org/ads"){this.$contentPlaceholder.fadeOut(200);this.$blockOnPlaceholder.fadeOut(200);this.$buttonsOnPlaceholder.fadeOut(200);}else{this.$buttonsOnPlaceholder.fadeIn(400);this.$blockOnPlaceholder.fadeIn(400);this.$contentPlaceholder.fadeIn(400);}}}}};Ans.prototype._ready=function(){this.searchBlock.initialize();if(this.historyAvailable&&this.dinamycAdsLoading){var popped=history.state?true:false,href=location.href;$(window).on("popstate",function(){var initialPop=!popped&&location.href===href;popped=true;if(!initialPop){var indexOfAdsPath=href.indexOf("/ads");if(indexOfAdsPath===-1){location.href=href;}else{var urlSuffix=location.href.substr(indexOfAdsPath+4);var paramsIndex=urlSuffix.indexOf("?");if(paramsIndex!==-1){urlSuffix=urlSuffix.substr(0,paramsIndex);}this.searchBlock.reload(urlSuffix,history.state?history.state.params:null,false);}}}.bind(this));}};Ans.prototype.updateAdsContent=function(url,params,saveState){if(this.adsRequest){this.adsRequest.abort();this.adsRequest=null;}this.$contentPlaceholderLoader.show();this.$contentPlaceholder.fadeIn(400);this.$blockOnPlaceholder.fadeIn(400);this.adsRequest=$.ajax({url:url+(url.indexOf("?")===-1?"?":"&")+"ajaxRequest=on",data:params?params:"",type:params?"POST":"GET",success:function(html){this.adsRequest=null;var contentDiv=$("div#content");contentDiv.html(html);var title=contentDiv.find(".page-title").text()||"";if(title){document.title=title;}this._initContentBlock();var newURL=url+(params?(url.indexOf("?")===-1?"?":"&")+params:"");if(saveState){history.pushState({params:params},document.title,newURL);}this.$blockOnPlaceholder.fadeOut(200);this.$contentPlaceholder.fadeOut(200);this.$contentPlaceholderLoader.hide();if(typeof(ga)==="function"){ga("send","pageview",{"page":newURL,"title":title});}if(typeof(yaCounter15239674)!=="undefined"&&typeof(yaCounter15239674.hit)==="function"){yaCounter15239674.hit(newURL,title);}var footerCountersContainer=$('.footer-counters:not([data-local-deploy="1"])');if(footerCountersContainer.length){footerCountersContainer.html('<noindex><span class="footertext" style="position:relative; top:-3px;">Участник</span> '+'<a class="footertext" style="margin-right:20px; position:relative; top:-3px;" '+'href="http://top100.rambler.ru/home?id=727637" target="_blank">Рамблер-Топ100</a></noindex>'+'<a href="http://www.liveinternet.ru/click" target="_blank">'+'<img src="//counter.yadro.ru/hit?t26.1;r'+escape(document.referrer)+((typeof(screen)=="undefined")?"":";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+";"+Math.random()+'" alt="" title="LiveInternet: показано число посетителей за'+' сегодня" border="0" width="88" height="15"></a>');}}.bind(this)});};})(window,window.ru.cmlt.patterns.Page,window.ru.cmlt.widgets,window.ru.cmlt.utils,window.jQuery,window._);